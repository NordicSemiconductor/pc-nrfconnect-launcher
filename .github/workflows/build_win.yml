name: Build nRF Connect for Desktop for Windows x64

on:
    workflow_dispatch:
        inputs:
    workflow_call:

jobs:
    build:
        runs-on: windows-latest
        steps:
            - uses: actions/checkout@v4
            - name: Build
              uses: ./.github/actions/build-action

            - name: Fetch certificate file
              shell: bash
              env:
                  SM_CLIENT_CERT_FILE_B64:
                      ${{ secrets.NORDIC_SM_CLIENT_CERT_P12 }}
              run:
                  echo "$SM_CLIENT_CERT_FILE_B64" | base64 --decode >
                  ./Certificate_pkcs12.pfx
              if: github.event_name != 'pull_request'

            - name: Set variables
              shell: bash
              run: |
                  echo "SM_HOST=${{ secrets.NORDIC_SM_HOST }}" >> "$GITHUB_ENV"
                  echo "SM_API_KEY=${{ secrets.NORDIC_SM_API_KEY }}" >> "$GITHUB_ENV"
                  echo "SM_CLIENT_CERT_FILE=D:\\Certificate_pkcs12.p12" >> "$GITHUB_ENV"
                  echo "SM_CLIENT_CERT_PASSWORD=${{ secrets.NORDIC_SM_CLIENT_CERT_PASSWORD }}" >> "$GITHUB_ENV"
                  echo "SM_CODE_SIGNING_CERT_SHA1_HASH=${{ env.NORDIC_SM_CERTIFICATE_SHA1_HASH }}" >> "$GITHUB_ENV"
              if: github.event_name != 'pull_request'

            - name: Code signing with Software Trust Manager
              uses: digicert/ssm-code-signing@v0.0.2
              env:
                  SM_API_KEY: ${{ env.SM_API_KEY }}
                  SM_CLIENT_CERT_PASSWORD: ${{ env.SM_CLIENT_CERT_PASSWORD }}
                  SM_CLIENT_CERT_FILE: ${{ env.SM_CLIENT_CERT_FILE }}
              if: github.event_name != 'pull_request'

            - name: Initiate the client tools setup
              run:
                  echo “The config file path ${{
                  steps.SSMClientToolSetup.outputs.PKCS11_CONFIG }}”

            - name: Run Electron Builder
              run: npx electron-builder -p never --windows nsis:x64
              if: github.event_name != 'pull_request'

            - name: Upload
              uses: ./.github/actions/publish-action
              with:
                  suffix: windows-x64
              if: github.event_name != 'pull_request'
