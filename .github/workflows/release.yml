name: Release to GitHub

on:
    workflow_dispatch:
        inputs:
            run_id:
                description: 'The workflow id where the artifacts were uploaded'
                required: true
                type: string
            tag:
                description: 'Tag to be used (e.g. v8.8.8)'
                required: true
                type: string

jobs:
    release:
        runs-on: ['ubuntu-latest']
        steps:
            - uses: actions/checkout@v4
            - name: Download artifacts
              uses: dawidd6/action-download-artifact@v3
              with:
                  run_id: ${{ inputs.run_id }}

            - name: Merge latest-mac.yml
              run: |
                  ls -R
                  rm package.json package-lock.json
                  mv nrfconnect-macOS-x64/latest-mac-x64.yml nrfconnect-macOS-arm64/
                  mv scripts/mergeLatestYmls.js nrfconnect-macOS-arm64/
                  cd nrfconnect-macOS-arm64
                  npm i js-yaml
                  node mergeLatestYmls.js latest-mac-x64.yml latest-mac-arm64.yml latest-mac.yml
                  rm latest-mac-x64.yml latest-mac-arm64.yml

            - name: Create Release
              uses: ncipollo/release-action@v1.13.0
              with:
                  allowUpdates: false
                  artifacts: 'nrfconnect-*/*.AppImage,nrfconnect-*/*.exe,nrfconnect-*/*.dmg,nrfconnect-*/*.zip,nrfconnect-*/latest*.yml'
                  tag: ${{ inputs.tag }}
                  draft: true
