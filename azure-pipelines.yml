trigger:
    - master
    - release/*

jobs:
    - job: Build
      variables:
          - group: wayland
          - name: TZ
            value: 'Europe/Oslo'
          - name: WIN_TZ
            value: 'W. Europe Standard Time'
          - name: NODE_VERSION
            value: 14.18.0
      strategy:
          matrix:
              linux:
                  IMAGE_NAME: 'ubuntu-18.04'
      pool:
          vmImage: $(IMAGE_NAME)
      steps:
          - script: tzutil /s "$(WIN_TZ)"
            condition: contains(variables['IMAGE_NAME'], 'win')
            displayName: 'Fix Windows timezone'
          - task: NodeTool@0
            inputs:
                versionSpec: $(NODE_VERSION)
            condition: ne(variables['NODE_ARCH'], '32')
            displayName: 'Install Node.js $(NODE_VERSION)'

          - bash: |
                set -o errexit -o pipefail
                choco install -y nvm
                export PATH=$NVM_HOME:$PATH
                nvm install $(NODE_VERSION) $(NODE_ARCH)
                nvm use $(NODE_VERSION) $(NODE_ARCH)
                ln -sf "$NVM_SYMLINK/node" "$NODE_SYMLINK/node"
            env:
                {
                    NVM_HOME: '/C/ProgramData/nvm',
                    NVM_SYMLINK: '/C/ProgramData/nvm/v$(NODE_VERSION)',
                    NODE_SYMLINK: '/C/Program Files/nodejs',
                }
            condition: and(contains(variables['IMAGE_NAME'], 'win'), eq(variables['NODE_ARCH'], '32'))
            displayName: 'Install Node.js $(NODE_VERSION) 32-bit'

          - bash: |
                set -o errexit -o pipefail
                sudo apt-get update
                sudo apt-get install libudev-dev
                sudo sysctl kernel.unprivileged_userns_clone=1
            condition: contains(variables['IMAGE_NAME'], 'ubuntu')
            displayName: 'Setup build environment for Linux'

          - bash: |
                set -o errexit -o pipefail
                npm ci
                npm run lint
                npm run build
                npx playwright install 
                npm run test-e2e
            condition: contains(variables['IMAGE_NAME'], 'ubuntu')
            displayName: 'Run e2e tests [Linux]'
